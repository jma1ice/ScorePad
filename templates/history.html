{% extends "base.html" %}

{% block title %}Game History{% endblock %}

{% block content %}
    <div class="game-header">
        <h1 class="game-title-header">Game History</h1>
        <p class="game-subtitle">View and manage your past games</p>
    </div>

    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 style="color: #2d3748; margin: 0;">All Games</h2>
            <div class="flex gap-2">
                <select id="filter-game" class="form-input" style="width: auto;">
                    <option value="">All Games</option>
                    <option value="bridge">Bridge</option>
                    <option value="rummy">Rummy</option>
                    <option value="canasta">Canasta</option>
                    <option value="hearts">Hearts</option>
                    <option value="spades">Spades</option>
                </select>
                <select id="filter-status" class="form-input" style="width: auto;">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
        </div>

        <div id="games-list">
            {% if games %}
                <div style="overflow-x: auto;">
                    <table class="score-table">
                        <thead>
                            <tr>
                                <th>Game</th>
                                <th>Variant</th>
                                <th>Players</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in games %}
                                <tr>
                                    <td>
                                        <strong>{{ game[1].title() }}</strong>
                                    </td>
                                    <td>
                                        {% if game[2] %}
                                            {{ game[2].replace('_', ' ').title() }}
                                        {% else %}
                                            Standard
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set players = game[3]|from_json %}
                                        {{ players|join(', ') if players else 'Unknown' }}
                                    </td>
                                    <td>
                                        {{ game[4][:10] if game[4] else 'Unknown' }}
                                    </td>
                                    <td>
                                        <span class="badge {% if game[6] == 'completed' %}badge-success{% else %}badge-warning{% endif %}">
                                            {{ game[6] }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            {% if game[6] == 'active' %}
                                                <a href="/play/{{ game[1] }}/{{ game[2] or 'basic' }}?game_id={{ game[0] }}" 
                                                class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                                    <i class="fa-solid fa-play"></i>
                                                    Continue
                                                </a>
                                            {% endif %}
                                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                                    onclick="viewGameDetails('{{ game[0] }}')">
                                                <i class="fa-solid fa-eye"></i>
                                                View
                                            </button>
                                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                                    onclick="deleteGame('{{ game[0] }}')">
                                                <i class="fa-solid fa-trash"></i>
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center" style="padding: 3rem;">
                    <i class="fa-solid fa-inbox" style="font-size: 3rem; color: #cbd5e0; margin-bottom: 1rem;"></i>
                    <h3 style="color: #718096; margin-bottom: 0.5rem;">No Games Found</h3>
                    <p style="color: #a0aec0;">Start a new game to see it appear here.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary mt-2">
                        <i class="fa-solid fa-plus"></i>
                        Start New Game
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="game-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Game Details</h3>
                <button onclick="closeModal()" class="btn-close">&times;</button>
            </div>
            <div id="modal-body">
            </div>
        </div>
    </div>

    <script>
        document.getElementById('filter-game').addEventListener('change', filterGames);
        document.getElementById('filter-status').addEventListener('change', filterGames);

        function filterGames() {
            const gameFilter = document.getElementById('filter-game').value;
            const statusFilter = document.getElementById('filter-status').value;
            
            const rows = document.querySelectorAll('.score-table tbody tr');
            
            rows.forEach(row => {
                const gameType = row.querySelector('td:first-child strong').textContent.toLowerCase();
                const status = row.querySelector('.badge').textContent.trim().toLowerCase();
                
                const gameMatch = !gameFilter || gameType === gameFilter;
                const statusMatch = !statusFilter || status === statusFilter;
                
                row.style.display = (gameMatch && statusMatch) ? '' : 'none';
            });
        }

        function viewGameDetails(gameId) {
            fetch(`/api/game/${gameId}`)
                .then(response => response.json())
                .then(data => {
                    const game = data.game;
                    const scores = data.scores;
                    
                    const playerTotals = {};
                    game.players.forEach(player => playerTotals[player] = 0);
                    scores.forEach(score => {
                        playerTotals[score.player] += score.score;
                    });
                    
                    const modalBody = document.getElementById('modal-body');
                    modalBody.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <h4>${game.game_type.charAt(0).toUpperCase() + game.game_type.slice(1)} - ${(game.variant || 'Standard').replace('_', ' ')}</h4>
                            <p><strong>Status:</strong> ${game.status}</p>
                            <p><strong>Players:</strong> ${game.players.join(', ')}</p>
                            <p><strong>Created:</strong> ${new Date(game.created_at).toLocaleString()}</p>
                            ${game.completed_at ? `<p><strong>Completed:</strong> ${new Date(game.completed_at).toLocaleString()}</p>` : ''}
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <h5>Final Scores:</h5>
                            ${Object.entries(playerTotals)
                                .sort((a, b) => b[1] - a[1])
                                .map(([player, total]) => `
                                    <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                        <span>${player}</span>
                                        <span><strong>${total}</strong></span>
                                    </div>
                                `).join('')}
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <h5>Recent Rounds:</h5>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${scores.slice(-10).map(score => `
                                    <div style="font-size: 0.9rem; padding: 0.25rem 0; border-bottom: 1px solid #eee;">
                                        Round ${score.round}: ${score.player} scored ${score.score > 0 ? '+' : ''}${score.score}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            ${game.status === 'active' ? `
                                <a href="/play/${game.game_type}/${game.variant || 'basic'}?game_id=${game.id}" 
                                class="btn btn-primary">
                                    <i class="fas fa-play"></i> Continue Game
                                </a>
                            ` : ''}
                            <button onclick="exportGame('${game.id}')" class="btn btn-secondary">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('game-modal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error loading game details:', error);
                    if (window.CardGameScorer) {
                        CardGameScorer.showNotification('Error loading game details', 'error');
                    }
                });
        }

        function deleteGame(gameId) {
            if (confirm('Are you sure you want to delete this game? This action cannot be undone.')) {
                fetch(`/api/game/${gameId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (window.CardGameScorer) {
                            CardGameScorer.showNotification('Game deleted successfully', 'success');
                        }
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        if (window.CardGameScorer) {
                            CardGameScorer.showNotification('Error deleting game', 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error deleting game:', error);
                    if (window.CardGameScorer) {
                        CardGameScorer.showNotification('Error deleting game', 'error');
                    }
                });
            }
        }

        function exportGame(gameId) {
            window.open(`/api/game/${gameId}/export`, '_blank');
            if (window.CardGameScorer) {
                CardGameScorer.showNotification('Export started - check your downloads', 'success');
            }
        }

        function closeModal() {
            document.getElementById('game-modal').classList.add('hidden');
        }

        document.getElementById('game-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

    <style>
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        .badge-warning {
            background: #fed7d7;
            color: #c53030;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }

        .btn-close:hover {
            color: #2d3748;
        }
    </style>
{% endblock %}
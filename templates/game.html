{% extends "base.html" %}

{% block title %}{{ game_config.name if game_config.name else game_type.title() }} - Playing{% endblock %}

{% block content %}
    <div class="game-header">
        <h1 class="game-title-header">{{ game_config.name if game_config.name else (game_type.title() + ' - ' + variant.replace('_', ' ').title()) }}</h1>
        <p class="game-subtitle">Game ID: {{ game_id }}</p>
    </div>

    <div class="game-layout">
        <div class="game-main">
            <div class="card score-section">
                <h2 style="margin-bottom: 1.5rem; color: #2d3748; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-calculator"></i>
                    Score Entry
                </h2>
                
                <form id="score-form">
                    <div class="score-input-grid">
                        <div class="form-group">
                            <label class="form-label">Player</label>
                            <select class="form-input" name="player" required>
                                <option value="">Select Player</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Round</label>
                            <input type="number" class="form-input" name="round" value="1" min="1" required>
                        </div>
                        
                        {% if game_type == 'bridge' %}
                            <div class="form-group">
                                <label class="form-label">Contract Bid</label>
                                <input type="text" class="form-input" name="bid" placeholder="e.g., 3NT, 4â™ , Pass">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Made Contract?</label>
                                <select class="form-input" name="made_bid">
                                    <option value="">Select Result</option>
                                    <option value="true">Made</option>
                                    <option value="false">Failed</option>
                                    <option value="over">Made with overtricks</option>
                                </select>
                            </div>
                        {% endif %}
                        
                        <div class="form-group">
                            <label class="form-label">Score</label>
                            <input type="number" class="form-input" name="score" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes (Optional)</label>
                            <input type="text" class="form-input" name="notes" placeholder="Additional notes">
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-plus"></i>
                            Add Score
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <i class="fa-solid fa-undo"></i>
                            Clear
                        </button>
                    </div>
                </form>
            </div>

            <div class="card mt-4">
                <h2 style="margin-bottom: 1.5rem; color: #2d3748; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-list"></i>
                    Score History
                </h2>
                
                <div style="overflow-x: auto;">
                    <table class="score-table">
                        <thead>
                            <tr>
                                <th>Round</th>
                                <th>Player</th>
                                {% if game_type == 'bridge' %}<th>Bid</th><th>Result</th>{% endif %}
                                <th>Score</th>
                                <th>Total</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="score-history">
                            <tr>
                                <td colspan="{% if game_type == 'bridge' %}8{% else %}6{% endif %}" style="text-align: center; color: #718096;">
                                    No scores entered yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card mt-4">
                <h2 style="margin-bottom: 1.5rem; color: #2d3748;">Game Controls</h2>
                <div class="flex gap-2">
                    <button class="btn btn-success" onclick="finishGame()">
                        <i class="fa-solid fa-flag-checkered"></i>
                        Finish Game
                    </button>
                    <button class="btn btn-secondary" onclick="exportScores()">
                        <i class="fa-solid fa-download"></i>
                        Export
                    </button>
                    <button class="btn btn-secondary" onclick="resetGame()">
                        <i class="fa-solid fa-trash"></i>
                        Reset Game
                    </button>
                </div>
            </div>
        </div>

        <div class="game-sidebar">
            {% if game_config.quick_tips %}
                <div class="card quick-tips">
                    <h3 class="tips-title">
                        <i class="fa-solid fa-lightbulb"></i>
                        Quick Tips
                    </h3>
                    <ul class="tips-list">
                        {% for tip in game_config.quick_tips %}
                            <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if game_config.scoring_info %}
                <div class="card mt-2">
                    <h3 class="tips-title">
                        <i class="fa-solid fa-calculator"></i>
                        Scoring
                    </h3>
                    <ul class="tips-list">
                        {% for info in game_config.scoring_info %}
                            <li>{{ info }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if game_config.rules_url %}
                <div class="card mt-2">
                    <h3 class="tips-title">
                        <i class="fa-solid fa-book"></i>
                        Rules
                    </h3>
                    <a href="{{ game_config.rules_url }}" target="_blank" class="external-link">
                        <i class="fa-solid fa-external-link-alt"></i>
                        View Complete Rules
                    </a>
                </div>
            {% endif %}

            <div class="card mt-2">
                <h3 class="tips-title">
                    <i class="fa-solid fa-trophy"></i>
                    Current Totals
                </h3>
                <div id="current-totals">
                    <p style="color: #718096;">No scores yet</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gameId = '{{ game_id }}';
        const gameType = '{{ game_type }}';
        let players = [];
        let scores = [];
        let currentRound = 1;

        document.addEventListener('DOMContentLoaded', function() {
            loadGameData();
            loadScores();
        });

        function loadGameData() {
            const urlParams = new URLSearchParams(window.location.search);
            players = urlParams.getAll('players');
            
            const playerSelect = document.querySelector('select[name="player"]');
            playerSelect.innerHTML = '<option value="">Select Player</option>';
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                playerSelect.appendChild(option);
            });
        }

        function loadScores() {
            fetch(`/api/scores/${gameId}`)
                .then(response => response.json())
                .then(data => {
                    scores = data;
                    updateScoreTable();
                    updateCurrentTotals();
                    updateCurrentRound();
                })
                .catch(error => {
                    console.error('Error loading scores:', error);
                });
        }

        function updateScoreTable() {
            const tbody = document.getElementById('score-history');
            
            if (scores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${gameType === 'bridge' ? '8' : '6'}" style="text-align: center; color: #718096;">
                            No scores entered yet
                        </td>
                    </tr>
                `;
                return;
            }

            const playerTotals = {};
            players.forEach(player => playerTotals[player] = 0);

            tbody.innerHTML = scores.map((score, index) => {
                playerTotals[score.player] += score.score;
                
                let bidColumns = '';
                if (gameType === 'bridge') {
                    const madeText = score.made_bid === null ? '-' : 
                                score.made_bid === 'true' ? 'Made' :
                                score.made_bid === 'false' ? 'Failed' : 'Made+';
                    bidColumns = `
                        <td>${score.bid || '-'}</td>
                        <td>${madeText}</td>
                    `;
                }
                
                return `
                    <tr>
                        <td>${score.round}</td>
                        <td><strong>${score.player}</strong></td>
                        ${bidColumns}
                        <td>${score.score > 0 ? '+' : ''}${score.score}</td>
                        <td><strong>${playerTotals[score.player]}</strong></td>
                        <td>${score.notes || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" 
                                    onclick="deleteScore(${index})">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateCurrentTotals() {
            const totalsDiv = document.getElementById('current-totals');
            
            if (scores.length === 0) {
                totalsDiv.innerHTML = '<p style="color: #718096;">No scores yet</p>';
                return;
            }

            const playerTotals = {};
            players.forEach(player => playerTotals[player] = 0);
            
            scores.forEach(score => {
                playerTotals[score.player] += score.score;
            });

            const sortedPlayers = Object.entries(playerTotals)
                .sort((a, b) => b[1] - a[1]);

            totalsDiv.innerHTML = sortedPlayers.map(([player, total], index) => {
                const position = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `${index + 1}.`;
                return `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                        <span>${position} ${player}</span>
                        <span style="font-weight: 600;">${total}</span>
                    </div>
                `;
            }).join('');
        }

        function updateCurrentRound() {
            if (scores.length === 0) {
                currentRound = 1;
            } else {
                currentRound = Math.max(...scores.map(s => s.round)) + 1;
            }
            document.querySelector('input[name="round"]').value = currentRound;
        }

        document.getElementById('score-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const scoreData = {
                game_id: gameId,
                player: formData.get('player'),
                round_number: parseInt(formData.get('round')),
                score: parseInt(formData.get('score')),
                bid: formData.get('bid'),
                made_bid: formData.get('made_bid') === '' ? null : formData.get('made_bid'),
                notes: formData.get('notes')
            };
            
            fetch('/api/score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scoreData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadScores();
                    clearForm();
                } else {
                    alert('Error adding score');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding score');
            });
        });

        function clearForm() {
            document.getElementById('score-form').reset();
            updateCurrentRound();
        }

        function deleteScore(index) {
            if (confirm('Are you sure you want to delete this score entry?')) {
                alert('Score deletion not implemented yet - would delete score at index ' + index);
            }
        }

        function finishGame() {
            if (confirm('Are you sure you want to finish this game?')) {
                alert('Game completion not implemented yet');
            }
        }

        function exportScores() {
            alert('Export functionality not implemented yet');
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset this game? All scores will be deleted.')) {
                alert('Game reset not implemented yet');
            }
        }
    </script>
{% endblock %}